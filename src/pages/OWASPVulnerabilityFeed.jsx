import React, { useEffect, useState, useRef } from 'react';
import { db } from '../firebaseConfig';
import { collection, query, orderBy, onSnapshot } from 'firebase/firestore';

const getSeverityClass = (severity) => {
  const normalizedSeverity = severity?.toLowerCase() || 'unknown';
  switch (normalizedSeverity) {
    case 'critical': return 'sev-critical';
    case 'high': return 'sev-high';
    case 'medium': return 'sev-medium';
    case 'low': return 'sev-low';
    default: return 'sev-unknown';
  }
};

const OWASPVulnerabilityFeed = () => {
  const [vulns, setVulns] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [expandedVulnId, setExpandedVulnId] = useState(null);
  const [highlightedVulnId, setHighlightedVulnId] = useState(null);
  const [expandedCategory, setExpandedCategory] = useState(null);

  const vulnRefs = useRef({});

  useEffect(() => {
    const vulnsCollection = collection(db, 'vulnerabilities');
    const q = query(vulnsCollection, orderBy('published', 'desc'));

    const unsubscribe = onSnapshot(q, (querySnapshot) => {
      const vulnerabilitiesData = [];
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        // ⚠️ CORRECTED: Filter out "Uncategorized" documents on the frontend
        if (data.id && data.title && data.published && data.category && data.category !== 'Uncategorized') {
          vulnerabilitiesData.push(data);
        }
      });
      setVulns(vulnerabilitiesData);
      setLoading(false);
      setError(null);
    }, (error) => {
      console.error("Error fetching vulnerabilities in real-time:", error);
      setError("Failed to load vulnerability data. Please check your connection.");
      setLoading(false);
    });

    return () => unsubscribe();
  }, []);

  const handleDescriptionClick = (id) => {
    setExpandedVulnId(expandedVulnId === id ? null : id);
  };

  const handleVulnCardClick = (vulnId, event) => {
    event.preventDefault();
    const targetElement = vulnRefs.current[vulnId];
    if (targetElement) {
      const rect = targetElement.getBoundingClientRect();
      const elementTop = rect.top + window.scrollY;
      const elementHeight = rect.height;
      const windowHeight = window.innerHeight;
      const scrollTo = elementTop - (windowHeight / 2) + (elementHeight / 2);

      window.scrollTo({
        top: scrollTo,
        behavior: 'smooth'
      });

      setTimeout(() => {
        setHighlightedVulnId(vulnId);
      }, 100);

      setTimeout(() => {
        setHighlightedVulnId(null);
      }, 1300);
    }
  };

  const handleCategoryToggle = (category) => {
    setExpandedCategory(expandedCategory === category ? null : category);
  };

  const getCVEsByCategory = (categoryName) => {
    return vulns.filter(v => v.category?.startsWith(categoryName));
  };

  const criticalAlerts = vulns
  .slice(0, 12) // Only look at the current 12 vulnerabilities in feed
  .filter(v => {
    const severity = v.severity?.toUpperCase();
    return severity === 'CRITICAL' || severity === 'HIGH';
  });

  const trends = vulns.reduce((acc, v) => {
    const categoryName = v.category?.split('-')[0];
    if (categoryName) {
      acc[categoryName] = (acc[categoryName] || 0) + 1;
    }
    return acc;
  }, {});
  const sortedTrends = Object.entries(trends).sort((a, b) => b[1] - a[1]);

  const topVulnerabilities = [...vulns].sort((a, b) => (b.score || 0) - (a.score || 0)).slice(0, 4);

  return (
    <div className="vuln-container">
      <h1 className="heading">CyberShield - Real-time Vulnerability Feed</h1>
      {loading ? (
        <div className="loading-container">
          <div className="spinner"></div>
          <p>Initializing live feed...</p>
        </div>
      ) : error ? (
        <div className="error-container">
          <p>{error}</p>
        </div>
      ) : (
        <>
          <section className="dashboard">
            <div className="card alert">
              <h3>Current Critical Alerts</h3>
              <p className="metric">{criticalAlerts.length}</p>
              <span>High & Critical CVEs (Currently)</span>
            </div>
            <div className="card trending">
              <h3>Top OWASP Categories</h3>
              <ul className="category-list">
                {sortedTrends.length > 0 ? sortedTrends.map(([cat, count]) => (
                  <li key={cat} className="category-item">
                    <div className="category-header">
                      <span className="category-info">
                        <strong>{cat}</strong> - {count} reports
                      </span>
                      <button
                        className="category-dropdown-btn"
                        onClick={() => handleCategoryToggle(cat)}
                        aria-label={`Toggle ${cat} CVEs`}
                      >
                        <svg
                          className={`dropdown-icon ${expandedCategory === cat ? 'rotated' : ''}`}
                          width="12"
                          height="12"
                          viewBox="0 0 12 12"
                          fill="currentColor"
                        >
                          <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" strokeWidth="1.5" fill="none" strokeLinecap="round" strokeLinejoin="round" />
                        </svg>
                      </button>
                    </div>
                    {expandedCategory === cat && (
                      <div className="category-dropdown">
                        <div className="category-cves">
                          {getCVEsByCategory(cat).map(cve => (
                            <div key={cve.id} className="dropdown-cve-item">
                              <a
                                href="#"
                                onClick={(e) => handleVulnCardClick(cve.id, e)}
                                className="dropdown-cve-link"
                              >
                                {cve.id}
                              </a>
                              <span className={`dropdown-badge ${getSeverityClass(cve.severity)}`}>
                                {cve.severity}
                              </span>
                            </div>
                          ))}
                          {getCVEsByCategory(cat).length === 0 && (
                            <div className="no-cves">No CVEs available</div>
                          )}
                        </div>
                      </div>
                    )}
                  </li>
                )) : <li>No trending data available.</li>}
              </ul>
            </div>
            <div className="card severity">
              <h3>Highest Ranked Issues</h3>
              <ul>
                {topVulnerabilities.map(v => (
                  <li key={v.id}>
                    <span className={`badge ${getSeverityClass(v.severity)}`}>{v.severity}</span>
                    <a
                      href="#"
                      onClick={(e) => handleVulnCardClick(v.id, e)}
                      className="vuln-link"
                    >
                      {v.id}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </section>
          <section className="feed">
            <h2>Latest Vulnerabilities</h2>
            <div className="grid">
              {vulns.slice(0, 12).map((v) => (
                <div
                  className={`vuln-card ${highlightedVulnId === v.id ? 'highlighted' : ''}`}
                  key={v.id}
                  ref={el => vulnRefs.current[v.id] = el}
                >
                  <div className="card-header">
                    <a href={v.link} target="_blank" rel="noopener noreferrer" className="vuln-id">{v.id}</a>
                    <span className={`badge ${getSeverityClass(v.severity)}`}>{v.severity} ({v.score})</span>
                  </div>
                  <p
                    className="desc clickable-desc"
                    onClick={() => handleDescriptionClick(v.id)}
                  >
                    {v.title?.length > 150 && expandedVulnId !== v.id
                      ? `${v.title.slice(0, 150)}...`
                      : v.title
                    }
                  </p>
                  <p className="category"><strong>Category:</strong> {v.category}</p>
                  <p className="date"><strong>Published:</strong> {new Date(v.published).toLocaleString()}</p>
                </div>
              ))}
            </div>
          </section>
        </>
      )}
    </div>
  );
};

export default OWASPVulnerabilityFeed;